# AGENT.MD - Factum AI: Documentaci√≥n Completa para Desarrolladores

> **Documento T√©cnico para Jules y el Equipo de Desarrollo**  
> Esta documentaci√≥n explica en profundidad la arquitectura, componentes, flujos de datos y todo lo necesario para entender y trabajar con el proyecto Factum AI.

---

## üìã Tabla de Contenidos

1. [Visi√≥n General del Proyecto](#-visi√≥n-general-del-proyecto)
2. [Arquitectura del Sistema](#-arquitectura-del-sistema)
3. [Estructura del Proyecto](#-estructura-del-proyecto)
4. [Frontend - Aplicaci√≥n React](#-frontend---aplicaci√≥n-react)
5. [Backend - Funciones Lambda](#-backend---funciones-lambda)
6. [Flujo de Datos Completo](#-flujo-de-datos-completo)
7. [Servicios de AWS](#-servicios-de-aws)
8. [Configuraci√≥n y Variables de Entorno](#-configuraci√≥n-y-variables-de-entorno)
9. [Proceso de Despliegue](#-proceso-de-despliegue)
10. [Seguridad y Mejores Pr√°cticas](#-seguridad-y-mejores-pr√°cticas)
11. [Troubleshooting y Debugging](#-troubleshooting-y-debugging)

---

## üéØ Visi√≥n General del Proyecto

**Factum AI** es un sistema de **moderaci√≥n de contenido multimedia** que utiliza **inteligencia artificial** para detectar contenido inapropiado o expl√≠cito en im√°genes.

### ¬øQu√© Hace?

1. Un usuario sube una imagen a trav√©s de una interfaz web moderna (React)
2. La imagen se almacena temporalmente en AWS S3
3. Amazon Rekognition analiza la imagen usando machine learning
4. El sistema retorna un resultado indicando si la imagen contiene contenido inapropiado

### Stack Tecnol√≥gico Principal

```
Frontend:  React 19 + Vite + TailwindCSS
Backend:   AWS Lambda (Node.js) + API Gateway
Storage:   AWS S3
AI/ML:     Amazon Rekognition
```

### Casos de Uso

- ‚úÖ Moderaci√≥n de contenido generado por usuarios en redes sociales
- ‚úÖ Filtrado de im√°genes en plataformas de e-commerce
- ‚úÖ Protecci√≥n de comunidades online
- ‚úÖ Cumplimiento normativo (COPPA, GDPR, etc.)

---

## üèóÔ∏è Arquitectura del Sistema

### Diagrama de Arquitectura

La arquitectura sigue un patr√≥n **serverless** con separaci√≥n clara entre frontend y backend:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                        USUARIO                                  ‚îÇ
‚îÇ                     (Navegador Web)                             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                         ‚îÇ
                         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    FRONTEND (React App)                         ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ ImageUploader Component                            ‚îÇ      ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ ModerationResult Component                         ‚îÇ      ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ apiService (HTTP Client)                           ‚îÇ      ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                 ‚îÇ                        ‚îÇ
                 ‚ñº                        ‚ñº
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ  AWS API Gateway   ‚îÇ    ‚îÇ     AWS S3 Bucket    ‚îÇ
    ‚îÇ  (REST Endpoints)  ‚îÇ    ‚îÇ  (Image Storage)     ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
              ‚îÇ                          ‚ñ≤
              ‚ñº                          ‚îÇ
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê             ‚îÇ
    ‚îÇ  Lambda Functions   ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
    ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
    ‚îÇ 1. get-presigned-url‚îÇ‚îÄ‚îÄ‚ñ∫ Genera URLs firmadas para S3
    ‚îÇ 2. moderate-image   ‚îÇ‚îÄ‚îÄ‚ñ∫ Analiza imagen con Rekognition
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
               ‚îÇ
               ‚ñº
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ Amazon Rekognition   ‚îÇ
    ‚îÇ (Content Moderation) ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Flujo de Alto Nivel

1. **Solicitud de Upload**: Usuario selecciona imagen ‚Üí Frontend pide URL firmada
2. **Upload Directo**: Frontend sube imagen directamente a S3 (sin pasar por backend)
3. **An√°lisis**: Frontend solicita an√°lisis ‚Üí Lambda invoca Rekognition
4. **Resultado**: Rekognition retorna labels/confianza ‚Üí Lambda procesa ‚Üí Frontend muestra resultado

### Ventajas de Esta Arquitectura

‚úÖ **Escalabilidad**: Lambda escala autom√°ticamente seg√∫n demanda  
‚úÖ **Costos**: Pay-per-use, no servidores siempre corriendo  
‚úÖ **Performance**: Upload directo a S3 reduce latencia  
‚úÖ **Seguridad**: URLs prefirmadas con expiraci√≥n, IAM roles con permisos m√≠nimos  

---

## üìÅ Estructura del Proyecto

```
Factum-AI/
‚îÇ
‚îú‚îÄ‚îÄ factum-app/                      # üé® FRONTEND - Aplicaci√≥n React
‚îÇ   ‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ImageUploader.jsx    # Componente de carga de im√°genes
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ImageUploader.css
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ModerationResult.jsx # Componente de resultados
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ModerationResult.css
‚îÇ   ‚îÇ   ‚îÇ
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ apiService.js        # Cliente HTTP para API Gateway
‚îÇ   ‚îÇ   ‚îÇ
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ assets/                  # Im√°genes, iconos, etc.
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ App.jsx                  # Componente ra√≠z de la aplicaci√≥n
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ App.css                  # Estilos principales
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ main.jsx                 # Entry point de React
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index.css                # Estilos globales
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ public/                      # Archivos est√°ticos
‚îÇ   ‚îú‚îÄ‚îÄ .env                         # Variables de entorno (NO en git)
‚îÇ   ‚îú‚îÄ‚îÄ .env.example                 # Plantilla de variables de entorno
‚îÇ   ‚îú‚îÄ‚îÄ package.json                 # Dependencias del frontend
‚îÇ   ‚îú‚îÄ‚îÄ vite.config.js               # Configuraci√≥n de Vite
‚îÇ   ‚îî‚îÄ‚îÄ README.md
‚îÇ
‚îú‚îÄ‚îÄ lambda/                          # ‚ö° BACKEND - Funciones AWS Lambda
‚îÇ   ‚îú‚îÄ‚îÄ get-presigned-url/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ index.js                 # Generaci√≥n de URLs S3 firmadas
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ package.json
‚îÇ   ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ moderate-image/
‚îÇ       ‚îú‚îÄ‚îÄ index.js                 # An√°lisis de contenido con Rekognition
‚îÇ       ‚îî‚îÄ‚îÄ package.json
‚îÇ
‚îú‚îÄ‚îÄ docs/                            # üìö DOCUMENTACI√ìN
‚îÇ   ‚îú‚îÄ‚îÄ AWS_SETUP.md                 # Gu√≠a de configuraci√≥n AWS (paso a paso)
‚îÇ   ‚îî‚îÄ‚îÄ DEPLOYMENT.md                # Gu√≠a de despliegue a producci√≥n
‚îÇ
‚îú‚îÄ‚îÄ README.md                        # Documentaci√≥n general del proyecto
‚îî‚îÄ‚îÄ AGENT.MD                         # üëà Este documento
```

---

## üé® Frontend - Aplicaci√≥n React

### Tecnolog√≠as y Dependencias

```json
{
  "react": "^19.2.0",                    // Framework UI
  "react-dom": "^19.2.0",                // React DOM bindings
  "react-dropzone": "^14.3.5",           // Drag & drop de archivos
  "axios": "^1.7.9",                     // Cliente HTTP
  "@aws-sdk/client-s3": "^3.699.0",      // SDK S3 para upload directo
  "vite": "^7.2.4"                       // Build tool y dev server
}
```

### Componentes Principales

#### 1. **App.jsx** - Componente Ra√≠z

**Responsabilidades:**
- Manejo del estado global de la aplicaci√≥n
- Orquestaci√≥n de la carga y an√°lisis de im√°genes
- Gesti√≥n de errores

**Estado Manejado:**
```javascript
const [currentImageKey, setCurrentImageKey] = useState(null);     // S3 key de la imagen
const [currentImageName, setCurrentImageName] = useState(null);   // Nombre original
const [moderationResult, setModerationResult] = useState(null);   // Resultado del an√°lisis
const [isAnalyzing, setIsAnalyzing] = useState(false);            // Loading state
const [error, setError] = useState(null);                         // Mensajes de error
```

**Funciones Clave:**

- `handleUploadComplete(imageKey, imageName)`: Se ejecuta cuando la imagen se sube exitosamente a S3
  - Guarda la key y nombre de la imagen
  - Llama a `moderateImage()` del servicio API
  - Actualiza el estado seg√∫n el resultado

- `handleUploadError(errorMessage)`: Maneja errores durante la carga

- `handleReset()`: Reinicia el estado para analizar otra imagen

#### 2. **ImageUploader.jsx** - Componente de Carga

**Responsabilidades:**
- Interfaz drag & drop para selecci√≥n de archivos
- Validaci√≥n de tipo y tama√±o de archivo
- Upload a S3 usando URL prefirmada
- Feedback visual del progreso

**Flujo de Upload:**

```javascript
// 1. Usuario selecciona/arrastra archivo
onDrop(acceptedFiles) {
  // 2. Validaciones
  - Tipo: debe ser image/*
  - Tama√±o: m√°ximo 10MB
  
  // 3. Mostrar preview de la imagen
  const reader = new FileReader();
  reader.readAsDataURL(file);
  
  // 4. Solicitar URL prefirmada
  const { uploadUrl, imageKey } = await getPresignedUrl(file.name, file.type);
  
  // 5. Upload directo a S3
  await uploadToS3(uploadUrl, file);
  
  // 6. Notificar al componente padre
  onUploadComplete(imageKey, file.name);
}
```

**Caracter√≠sticas UX:**
- ‚ú® Animaciones de drag-over
- üìä Barra de progreso de upload (0% ‚Üí 100%)
- üñºÔ∏è Preview de la imagen antes/durante upload
- ‚ö†Ô∏è Mensajes de error descriptivos

#### 3. **ModerationResult.jsx** - Resultados del An√°lisis

**Responsabilidades:**
- Mostrar si la imagen es segura o inapropiada
- Visualizar nivel de confianza con barra de progreso
- Listar etiquetas de moderaci√≥n detectadas (opcional, colapsable)
- Bot√≥n para analizar otra imagen

**Datos Recibidos:**
```javascript
{
  isInappropriate: true/false,           // Clasificaci√≥n principal
  confidence: 85.5,                      // % de confianza del label principal
  labels: [                              // Todas las etiquetas detectadas
    { Name: "Explicit Nudity", Confidence: 95.2, ParentName: "Nudity" },
    { Name: "Graphic Content", Confidence: 88.7, ParentName: null }
  ],
  message: "Descripci√≥n en espa√±ol del resultado",
  threshold: 70                          // Umbral usado (70%)
}
```

**Estados Visuales:**
- ‚úÖ **Seguro**: Fondo verde, √≠cono de check
- ‚ö†Ô∏è **Inapropiado**: Fondo rojo/naranja, √≠cono de advertencia

### Capa de Servicios

#### **apiService.js** - Cliente HTTP

Centraliza todas las llamadas a AWS API Gateway:

```javascript
const API_BASE_URL = import.meta.env.VITE_API_GATEWAY_URL;

// 1. Obtener URL prefirmada para upload
export const getPresignedUrl = async (fileName, fileType) => {
  const response = await axios.post(`${API_BASE_URL}/presigned-url`, {
    fileName,
    fileType
  });
  return response.data; // { uploadUrl, imageKey, expiresIn }
}

// 2. Upload directo a S3
export const uploadToS3 = async (presignedUrl, file) => {
  await axios.put(presignedUrl, file, {
    headers: { 'Content-Type': file.type }
  });
}

// 3. Solicitar an√°lisis de moderaci√≥n
export const moderateImage = async (imageKey) => {
  const response = await axios.post(`${API_BASE_URL}/moderate`, {
    imageKey
  });
  return response.data;
}
```

### Configuraci√≥n de Vite

**vite.config.js:**
```javascript
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'

export default defineConfig({
  plugins: [react()],
  server: {
    port: 5173,
    host: true
  }
})
```

---

## ‚ö° Backend - Funciones Lambda

### Lambda 1: `get-presigned-url`

**Archivo:** `lambda/get-presigned-url/index.js`

**Prop√≥sito:** Generar URLs prefirmadas de S3 para que el frontend pueda hacer upload directo

**Input (JSON):**
```json
{
  "fileName": "vacation.jpg",
  "fileType": "image/jpeg"
}
```

**Output (JSON):**
```json
{
  "uploadUrl": "https://factum-bucket.s3.us-east-2.amazonaws.com/uploads/1703012345678-vacation.jpg?X-Amz-Algorithm=...",
  "imageKey": "uploads/1703012345678-vacation.jpg",
  "expiresIn": 300
}
```

**L√≥gica Principal:**

```javascript
// 1. Parse del body
const { fileName, fileType } = JSON.parse(event.body);

// 2. Validaciones
if (!fileType.startsWith('image/')) {
  return error(400, 'Only image files allowed');
}

// 3. Generar key √∫nico
const timestamp = Date.now();
const sanitizedFileName = fileName.replace(/[^a-zA-Z0-9.-]/g, '_');
const imageKey = `uploads/${timestamp}-${sanitizedFileName}`;

// 4. Crear comando S3 PutObject
const command = new PutObjectCommand({
  Bucket: BUCKET_NAME,
  Key: imageKey,
  ContentType: fileType
});

// 5. Generar URL firmada (v√°lida por 5 minutos)
const uploadUrl = await getSignedUrl(s3Client, command, { expiresIn: 300 });

return success({ uploadUrl, imageKey, expiresIn: 300 });
```

**Configuraci√≥n AWS:**
- **Runtime:** Node.js 20.x
- **Handler:** index.handler
- **Timeout:** 10 segundos
- **Memoria:** 256 MB
- **Permisos IAM:** `s3:PutObject` en el bucket espec√≠fico

**Manejo CORS:**
```javascript
const headers = {
  'Access-Control-Allow-Origin': '*',           // En producci√≥n: dominio espec√≠fico
  'Access-Control-Allow-Headers': 'Content-Type',
  'Access-Control-Allow-Methods': 'POST, OPTIONS'
};
```

### Lambda 2: `moderate-image`

**Archivo:** `lambda/moderate-image/index.js`

**Prop√≥sito:** Analizar imagen en S3 usando Amazon Rekognition

**Input (JSON):**
```json
{
  "imageKey": "uploads/1703012345678-vacation.jpg"
}
```

**Output (JSON):**
```json
{
  "isInappropriate": false,
  "confidence": 12.5,
  "labels": [
    {
      "Name": "Revealing Clothes",
      "Confidence": 12.5,
      "ParentName": "Suggestive"
    }
  ],
  "message": "La imagen es segura. No se detect√≥ contenido inapropiado.",
  "threshold": 70
}
```

**L√≥gica Principal:**

```javascript
// 1. Parse del body
const { imageKey } = JSON.parse(event.body);

// 2. Invocar Rekognition
const command = new DetectModerationLabelsCommand({
  Image: {
    S3Object: {
      Bucket: BUCKET_NAME,
      Name: imageKey
    }
  },
  MinConfidence: 60  // Retornar labels con confianza >= 60%
});

const response = await rekognitionClient.send(command);
const moderationLabels = response.ModerationLabels || [];

// 3. Evaluar labels contra categor√≠as expl√≠citas
const EXPLICIT_CATEGORIES = [
  'Explicit Nudity',
  'Nudity',
  'Graphic Male Nudity',
  'Graphic Female Nudity',
  'Sexual Activity',
  'Illustrated Explicit Nudity',
  'Adult Toys'
];

let isInappropriate = false;
let maxConfidence = 0;

for (const label of moderationLabels) {
  if (label.Confidence > maxConfidence) {
    maxConfidence = label.Confidence;
  }
  
  // Si alg√∫n label expl√≠cito supera el umbral ‚Üí inapropiado
  if (EXPLICIT_CATEGORIES.includes(label.Name) && label.Confidence >= 70) {
    isInappropriate = true;
  }
}

// 4. Preparar mensaje en espa√±ol
const message = isInappropriate 
  ? `Se detect√≥ contenido inapropiado con ${maxConfidence.toFixed(1)}% de confianza.`
  : 'La imagen es segura. No se detect√≥ contenido inapropiado.';

return success({
  isInappropriate,
  confidence: maxConfidence,
  labels: moderationLabels,
  message,
  threshold: 70
});
```

**Configuraci√≥n AWS:**
- **Runtime:** Node.js 20.x
- **Handler:** index.handler
- **Timeout:** 30 segundos (Rekognition puede tardar)
- **Memoria:** 512 MB
- **Permisos IAM:** 
  - `s3:GetObject` en el bucket
  - `rekognition:DetectModerationLabels`

---

## üîÑ Flujo de Datos Completo

### Secuencia Detallada

```mermaid
sequenceDiagram
    participant User as üë§ Usuario
    participant UI as üé® Frontend (React)
    participant API as üåê API Gateway
    participant L1 as ‚ö° Lambda: get-presigned-url
    participant S3 as üì¶ S3 Bucket
    participant L2 as ‚ö° Lambda: moderate-image
    participant AIR as ü§ñ Amazon Rekognition

    User->>UI: 1. Selecciona/Arrastra imagen
    UI->>UI: Validar tipo y tama√±o
    
    UI->>API: 2. POST /presigned-url<br/>{fileName, fileType}
    API->>L1: Invocar funci√≥n
    L1->>L1: Generar key √∫nico<br/>uploads/timestamp-filename.jpg
    L1->>L1: Crear URL S3 firmada (5 min)
    L1->>API: {uploadUrl, imageKey}
    API->>UI: Retornar URL firmada
    
    UI->>S3: 3. PUT uploadUrl<br/>(upload directo)
    S3->>UI: 200 OK
    
    UI->>API: 4. POST /moderate<br/>{imageKey}
    API->>L2: Invocar funci√≥n
    L2->>AIR: 5. DetectModerationLabels<br/>(S3Object: imageKey)
    AIR->>AIR: An√°lisis ML de la imagen
    AIR->>L2: 6. ModerationLabels[...]
    L2->>L2: 7. Evaluar labels contra umbral (70%)
    L2->>L2: Preparar mensaje en espa√±ol
    L2->>API: {isInappropriate, confidence, labels, message}
    API->>UI: Retornar resultado
    
    UI->>User: 8. Mostrar resultado visual
```

### Tiempos Estimados por Paso

| Paso | Acci√≥n | Tiempo Estimado |
|------|--------|-----------------|
| 1-2  | Validaci√≥n local + solicitar URL | 100-300ms |
| 3    | Upload a S3 | 500ms - 3s (seg√∫n tama√±o) |
| 4-5  | Invocar Lambda + Rekognition | 1-3s |
| 6-8  | Procesar y mostrar resultado | 200-500ms |
| **TOTAL** | **Flujo completo** | **~3-7 segundos** |

---

## ‚òÅÔ∏è Servicios de AWS

### 1. Amazon S3 (Simple Storage Service)

**Prop√≥sito:** Almacenar im√°genes subidas por usuarios

**Configuraci√≥n del Bucket:**

```json
{
  "BucketName": "factum-content-moderation",
  "Region": "us-east-2",
  "Versioning": "Disabled",
  "PublicAccess": "Blocked",
  "Encryption": "AES256"
}
```

**Pol√≠tica CORS:**

```json
[
  {
    "AllowedHeaders": ["*"],
    "AllowedMethods": ["PUT", "POST"],
    "AllowedOrigins": [
      "http://localhost:5173",
      "https://tu-dominio.com"
    ],
    "ExposeHeaders": ["ETag"],
    "MaxAgeSeconds": 3000
  }
]
```

**Lifecycle Policy (Limpieza Autom√°tica):**

```json
{
  "Rules": [
    {
      "Id": "DeleteOldUploads",
      "Status": "Enabled",
      "Prefix": "uploads/",
      "Expiration": {
        "Days": 7
      }
    }
  ]
}
```

### 2. AWS Lambda

**Costos Aproximados:**
- Primeros 1M requests/mes: GRATIS
- Despu√©s: $0.20 por mill√≥n de requests
- Compute: $0.0000166667 por GB-segundo

**Ejemplo:** 10,000 requests/mes con 512MB RAM y 2s promedio = **~$0.50/mes**

### 3. Amazon API Gateway

**Prop√≥sito:** Exponer endpoints HTTP para el frontend

**Configuraci√≥n:**

```
API Type: HTTP API (m√°s econ√≥mico que REST API)
Region: us-east-2 (misma regi√≥n que S3 y Lambda)

Endpoints:
  POST /presigned-url ‚Üí Lambda: get-presigned-url
  POST /moderate       ‚Üí Lambda: moderate-image

CORS: Habilitado
Throttling: 10,000 requests/segundo (default)
```

**URL de Producci√≥n:**
```
https://abc123xyz.execute-api.us-east-2.amazonaws.com/prod
```

### 4. Amazon Rekognition

**Prop√≥sito:** Detecci√≥n de contenido inapropiado usando ML

**M√©todo Usado:** `DetectModerationLabels`

**Categor√≠as Detectadas:**
- Explicit Nudity (desnudez expl√≠cita)
- Suggestive (contenido sugestivo)
- Violence (violencia)
- Visually Disturbing (contenido perturbador)
- Rude Gestures (gestos obscenos)
- Drugs (drogas)
- Tobacco (tabaco)
- Alcohol (alcohol)
- Gambling (apuestas)
- Hate Symbols (s√≠mbolos de odio)

**Costos:**
- Primeros 5,000 im√°genes/mes: GRATIS (primer a√±o)
- Despu√©s: $1.00 por 1,000 im√°genes

### 5. AWS CloudWatch

**Prop√≥sito:** Logs, m√©tricas y monitoreo

**Logs Generados:**
- `/aws/lambda/factum-get-presigned-url`
- `/aws/lambda/factum-moderate-image`

**M√©tricas Clave:**
- Invocaciones por minuto
- Duraci√≥n promedio
- Errores (4xx, 5xx)
- Throttles

---

## ‚öôÔ∏è Configuraci√≥n y Variables de Entorno

### Frontend (.env)

**Ubicaci√≥n:** `factum-app/.env`

```env
# URL base de API Gateway
VITE_API_GATEWAY_URL=https://abc123xyz.execute-api.us-east-2.amazonaws.com/prod

# Regi√≥n de AWS
VITE_AWS_REGION=us-east-2

# Nombre del bucket S3
VITE_S3_BUCKET_NAME=factum-content-moderation
```

> **‚ö†Ô∏è IMPORTANTE:** El archivo `.env` NO debe estar en git. Usar `.env.example` como plantilla.

**Acceso en React:**
```javascript
const apiUrl = import.meta.env.VITE_API_GATEWAY_URL;
```

### Backend (Lambda)

**Variables de Entorno por Funci√≥n:**

**get-presigned-url:**
```
AWS_REGION=us-east-2
S3_BUCKET_NAME=factum-content-moderation
```

**moderate-image:**
```
AWS_REGION=us-east-2
S3_BUCKET_NAME=factum-content-moderation
```

**Configuraci√≥n en AWS Console:**
Lambda ‚Üí Funci√≥n ‚Üí Configuration ‚Üí Environment variables

---

## üöÄ Proceso de Despliegue

### Despliegue del Backend (Lambda)

#### M√©todo 1: Manual desde AWS Console

```powershell
# get-presigned-url
cd lambda/get-presigned-url
npm install --production
Compress-Archive -Path * -DestinationPath function.zip -Force

# Subir function.zip en AWS Lambda Console
```

#### M√©todo 2: AWS CLI (Automatizado)

```powershell
# Script PowerShell: deploy-lambdas.ps1
cd lambda/get-presigned-url
npm install --production
Compress-Archive -Path * -DestinationPath function.zip -Force

aws lambda update-function-code `
    --function-name factum-get-presigned-url `
    --zip-file fileb://function.zip `
    --region us-east-2

Remove-Item function.zip
cd ../..

# Repetir para moderate-image
```

### Despliegue del Frontend

#### Opci√≥n 1: Vercel (Recomendado)

```bash
cd factum-app
npm install -g vercel
vercel login
vercel  # Primera vez: configurar proyecto
vercel --prod  # Deploy a producci√≥n
```

**Configurar variables en Vercel Dashboard:**
- Settings ‚Üí Environment Variables
- Agregar: `VITE_API_GATEWAY_URL`, `VITE_AWS_REGION`, `VITE_S3_BUCKET_NAME`

#### Opci√≥n 2: AWS S3 + CloudFront

```bash
cd factum-app
npm run build

aws s3 mb s3://factum-app-frontend --region us-east-2

aws s3 sync dist/ s3://factum-app-frontend --acl public-read

aws s3 website s3://factum-app-frontend \
    --index-document index.html \
    --error-document index.html
```

### Verificaci√≥n Post-Despliegue

```bash
# Test Lambda 1
aws lambda invoke \
    --function-name factum-get-presigned-url \
    --payload '{"body":"{\"fileName\":\"test.jpg\",\"fileType\":\"image/jpeg\"}"}' \
    response.json

cat response.json

# Test desde frontend
curl -X POST https://tu-api.execute-api.us-east-2.amazonaws.com/prod/presigned-url \
  -H "Content-Type: application/json" \
  -d '{"fileName":"test.jpg","fileType":"image/jpeg"}'
```

---

## üîí Seguridad y Mejores Pr√°cticas

### Seguridad Implementada

‚úÖ **URLs Prefirmadas con Expiraci√≥n**
- URLs v√°lidas solo por 5 minutos
- Previene uploads no autorizados

‚úÖ **CORS Configurado**
- Solo or√≠genes permitidos pueden hacer requests
- En producci√≥n: cambiar `*` por dominio espec√≠fico

‚úÖ **Validaci√≥n de Tipos de Archivo**
- Frontend y Lambda validan que sea `image/*`
- Previene uploads de ejecutables/scripts

‚úÖ **L√≠mite de Tama√±o**
- Frontend: 10MB m√°ximo
- S3: Se puede configurar bucket policy adicional

‚úÖ **IAM Roles de M√≠nimo Privilegio**
```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": "s3:PutObject",
      "Resource": "arn:aws:s3:::factum-content-moderation/uploads/*"
    },
    {
      "Effect": "Allow",
      "Action": "s3:GetObject",
      "Resource": "arn:aws:s3:::factum-content-moderation/uploads/*"
    },
    {
      "Effect": "Allow",
      "Action": "rekognition:DetectModerationLabels",
      "Resource": "*"
    }
  ]
}
```

‚úÖ **Lifecycle Policies**
- Las im√°genes se eliminan autom√°ticamente despu√©s de 7 d√≠as
- Reduce costos de almacenamiento y riesgos de privacidad

### Mejoras de Seguridad Recomendadas para Producci√≥n

üîê **Autenticaci√≥n de Usuarios**
```javascript
// Implementar JWT tokens o AWS Cognito
headers: {
  'Authorization': `Bearer ${token}`
}
```

üîê **Rate Limiting**
```javascript
// API Gateway: Throttling por API key
- 100 requests por minuto por usuario
- 10,000 requests por d√≠a
```

üîê **Validaci√≥n de Contenido Adicional**
```javascript
// Verificar dimensiones de imagen
// Verificar que no est√© corrupta
// Escaneo de malware (ClamAV)
```

üîê **Encriptaci√≥n en Tr√°nsito y en Reposo**
```
- HTTPS obligatorio (API Gateway)
- S3 Server-Side Encryption (SSE-S3 o KMS)
```

---

## üêõ Troubleshooting y Debugging

### Errores Comunes

#### 1. **Error: CORS Policy**

```
Access to fetch at '...' has been blocked by CORS policy
```

**Soluci√≥n:**
- Verificar CORS en S3 bucket
- Verificar CORS en API Gateway
- Verificar headers en Lambda responses

**Debug:**
```bash
# Ver configuraci√≥n CORS en S3
aws s3api get-bucket-cors --bucket factum-content-moderation

# Habilitar CORS en API Gateway
API Gateway ‚Üí Your API ‚Üí CORS ‚Üí Configure
```

#### 2. **Error: AccessDenied al subir a S3**

```
<Error>
  <Code>AccessDenied</Code>
  <Message>Request has expired</Message>
</Error>
```

**Causas:**
- URL prefirmada expir√≥ (>5 minutos)
- Clock skew (reloj del sistema desincronizado)

**Soluci√≥n:**
```javascript
// Aumentar tiempo de expiraci√≥n (desarrollo)
expiresIn: 600  // 10 minutos

// Sincronizar reloj del sistema
w32tm /resync
```

#### 3. **Error: "Cannot read properties of undefined"**

**Causa:** Variables de entorno no configuradas

**Soluci√≥n:**
```bash
# Verificar .env existe
ls factum-app/.env

# Verificar contenido
cat factum-app/.env

# Reiniciar servidor de desarrollo
npm run dev
```

#### 4. **Rekognition retorna labels vac√≠os**

**Causa:** Imagen demasiado peque√±a o borrosa

**Soluci√≥n:**
```javascript
// Validar resoluci√≥n m√≠nima
const MIN_WIDTH = 64;
const MIN_HEIGHT = 64;

// Usar MinConfidence m√°s bajo en casos espec√≠ficos
MinConfidence: 50  // en lugar de 60
```

### Debugging de Lambda Functions

**Ver logs en CloudWatch:**
```bash
aws logs tail /aws/lambda/factum-get-presigned-url --follow
```

**Test local con SAM:**
```bash
sam local invoke get-presigned-url -e events/test-event.json
```

**Habilitar X-Ray para tracing:**
```
Lambda ‚Üí Configuration ‚Üí Monitoring tools ‚Üí X-Ray ‚Üí Enable
```

### Debugging del Frontend

**Inspeccionar Network Requests:**
```
Chrome DevTools ‚Üí Network Tab
- Verificar status codes (200, 403, 500)
- Ver request/response bodies
- Verificar headers
```

**Console logs √∫tiles:**
```javascript
console.log('API Base URL:', import.meta.env.VITE_API_GATEWAY_URL);
console.log('Upload response:', response.data);
console.log('Moderation result:', moderationResult);
```

---

## üìä M√©tricas y Monitoreo

### CloudWatch Dashboards

**Crear dashboard personalizado:**

```json
{
  "widgets": [
    {
      "type": "metric",
      "properties": {
        "metrics": [
          ["AWS/Lambda", "Invocations", { "stat": "Sum" }],
          ["AWS/Lambda", "Errors", { "stat": "Sum" }],
          ["AWS/Lambda", "Duration", { "stat": "Average" }]
        ],
        "period": 300,
        "stat": "Sum",
        "region": "us-east-2",
        "title": "Lambda Performance"
      }
    }
  ]
}
```

### Alertas Importantes

1. **Lambda Errors > 5 en 5 minutos**
2. **API Gateway 5xx Errors > 10 en 5 minutos**
3. **S3 4xx Errors > 50 en 5 minutos**
4. **Lambda Duration > 25 segundos (near timeout)**

---

## üéì Recursos Adicionales

### Documentaci√≥n Oficial

- [AWS Lambda Developer Guide](https://docs.aws.amazon.com/lambda/)
- [Amazon Rekognition Moderation](https://docs.aws.amazon.com/rekognition/latest/dg/moderation.html)
- [React Documentation](https://react.dev/)
- [Vite Guide](https://vitejs.dev/guide/)

### Archivos de Configuraci√≥n del Proyecto

- [AWS_SETUP.md](docs/AWS_SETUP.md) - Configuraci√≥n paso a paso de AWS
- [DEPLOYMENT.md](docs/DEPLOYMENT.md) - Gu√≠a completa de despliegue
- [README.md](README.md) - Documentaci√≥n general del proyecto

---

## üìù Notas Finales para Jules

### ¬øQu√© Hace Este Sistema?

Este proyecto es un **moderador de contenido** que usa IA para detectar im√°genes inapropiadas. Es como tener un guardia de seguridad automatizado que revisa cada foto antes de permitir que se publique.

### Arquitectura en T√©rminos Simples

1. **React Frontend**: La cara visible, lo que ven los usuarios
2. **AWS Lambda**: El cerebro, procesa las solicitudes sin necesidad de servidores 24/7
3. **S3**: El almac√©n, guarda las im√°genes temporalmente
4. **Rekognition**: El experto en IA, analiza las im√°genes
5. **API Gateway**: El portero, controla qui√©n puede entrar y qu√© puede hacer

### Para Empezar a Desarrollar

```bash
# 1. Clonar el proyecto
git clone https://github.com/T0NY24/Factum-AI.git
cd Factum-AI

# 2. Instalar frontend
cd factum-app
npm install

# 3. Configurar .env (pedir valores al equipo)
cp .env.example .env
# Editar .env con los valores reales

# 4. Correr en desarrollo
npm run dev
# Abre http://localhost:5173
```

### Modificaciones Comunes

**Cambiar el umbral de detecci√≥n:**
```javascript
// lambda/moderate-image/index.js
const CONFIDENCE_THRESHOLD = 70; // Cambiar a 80 para ser m√°s estricto
```

**Agregar nuevas categor√≠as expl√≠citas:**
```javascript
const explicitCategories = [
  'Explicit Nudity',
  'Sexual Activity',
  'Nueva Categor√≠a Aqu√≠'  // A√±adir aqu√≠
];
```

**Cambiar tiempo de expiraci√≥n de URLs:**
```javascript
// lambda/get-presigned-url/index.js
const URL_EXPIRATION = 300; // Segundos (5 minutos)
```

---

**√öltima actualizaci√≥n:** Diciembre 2024  
**Mantenedores:** T0NY24 y equipo Factum AI  
**Licencia:** MIT
